# Initial page

## 1.1 什么是围棋

中国有句俗语“没吃过猪肉,谁还没见过猪跑”，用来形容围棋则是再恰当不过。围棋在古代被称作“弈”，也有人称它作“手谈”。两个人下围棋叫做对弈。中国有尧造围棋的说法，围棋起源于中国也是大家都认可的。有人认为围棋发祥之初仅仅是为了观测天文，而不是为了争夺胜负。即便如此，在尧1500年以后的春秋时代，围棋已经作为博弈游戏在人群中普及是可以肯定的。《左传·襄公二十五年》中就有记载说，“弈者举棋不定，不胜其耦”，意思是下棋的人如果拿着棋子却犹豫不定，就不能战胜对方。

当今围棋作为一种国际通行棋种流行于东亚（中、日、韩），在欧美国家也逐渐风行。围棋的英语名称是“Go”，来源于日本对围棋的称呼“囲碁”中的“碁”（日语中发类似go的音）。日常生活中的围棋棋具如图1-1所示。

一般一套围棋棋具由棋子与棋盘组成。棋子分黑白两色，多为扁圆形，材料多为树脂。在中国，棋子一般一面平整，一面凸起。行棋时，平整的一面向下落在棋盘上。在日本，棋子两面通常都是凸起的。一副棋子的数量一般是180枚，由于人类棋手几乎不会有把棋盘下满才结束的情况，所以这个数量在实际的日常使用中是完全足够的。围棋的棋盘一般使用一块正方形的木板，上面画上由横竖各十九条等距离、垂直交叉的平行线。纵横交错的38根直线共构成 $$19×19=361$$ 个交叉点。棋盘最中间的位置会专门画上一个点，这个点称作“天元”。在其它地方还会额外再画上八个小圆点，称作星位。由天元和星位这九个点把棋盘分割成“角”、“边”以及“中腹”三类区域。虽然角、边这些概念在下棋时非常重要，但是星位和天元只是棋盘上九个点的名称，在行棋时并没有实际意义。

如果进行围棋比赛，人们有时还会使用到一种叫“棋钟”的棋具，如图1-2所示。棋钟其实就是一种计时器，在正式的比赛中使用棋钟对双方选手思考和落子的时间进行限制。

随着互联网的普及，愈来愈多的人喜欢在网络上与别人进行下棋。在中国，“[弈城围棋网](https://github.com/liujiasearch/OneGo-Book/tree/7cd1492a11d0c573f4254f22178e97e641500c47/www.eweiqi.com)”是一个比较著名的围棋对弈网站。在国际上，[KGS](http://www.gokgs.com/)是最为热门的围棋对弈站点，它是完全免费的，来自世界各地的人们在上面相互切磋技艺。

网络上一套标准棋盘如图1-3所示。几乎所有的网上对弈棋盘都以二维的形式展现。双方的棋子用白色和黑色的原点表示，这一点和实物棋盘没有什么区别。除了通过互联网站下棋，一些围棋软件在棋友中使用也十分广泛，这些软件可以为围棋学习提供便利，也方便他们在亲朋好友间进行对弈。常见的围棋软件有[Gnu-Go](https://github.com/liujiasearch/OneGo-Book/tree/7cd1492a11d0c573f4254f22178e97e641500c47/www.gnu.org)和[Pachi](http://pachi.or.cz/)。这两款软件除了能够提供常规功能以外，还自带围棋智能程序（也称作AI引擎），通过装载它们便可以实现简单的人机对战。在[DeepMind](https://deepmind.com/)团队的[AlphaGo](https://deepmind.com/research/alphago/)出现之前，这两款软件自带的围棋智能程序曾一度是围棋领域所能实现的人工智能水平的典型代表。还有一些围棋软件仅具备图形界面，通常用来帮助棋友打谱或者方便人与人的对战。这些软件本身不带有下棋的AI引擎，围棋软件[Sabaki](https://sabaki.yichuanshen.de)就是其中的典型代表。图1-3显示的棋盘便是Sabaki软件上的截图。Sabaki自己不带有围棋智能程序，但是它可以通过装载其它软件的AI引擎实现人与计算机的对弈。值得称道的一点是它可以同时装载两种不同的AI引擎，使得黑棋与白棋可以自动对弈，这就像金庸先生的武侠小说《[神雕侠侣](http://www.jinyongwang.com/shen/)》里提到过的武功---“左右互搏术”。Sabaki的这个功能常常被用来评估两个不同的围棋智能程序棋力的强弱。

## 1.2 围棋的规则

我们不是必须成为围棋高手后才能做出一个高水平的围棋人工智能，不过了解围棋的基本规则却是必不可少的。论语记载了孔子的言论，其中有提到“学而时习之，不亦说乎”的道理，故此读者即便深谙围棋之道，还是建议不要跳过本小节，我会从让计算机实现围棋人工智能的角度来阐述它的游戏规则。

围棋通常有两名对弈者，分别执黑子与白子，称为黑方和白方。按现代围棋规则，双方以空盘开局，由黑方先行棋。开局后，双方轮流在空点处着子，每次最多只能落一枚棋子，棋子只能下在棋盘上的交叉点上，一旦落子就不能反悔，而且棋子下定后不可以在棋盘上移动棋子向其他位置运动。落子是行棋者的权利，如果愿意，行棋者可以选择不落子，跳过自己的回合，称作“虚着”或者“弃着”，即放弃行棋的权利。当双方连续都跳过自己的回合，此局便告结束，如果双方无人认输，则棋局进入胜负判定环节。

棋盘上相互连接的相同颜色的棋子称作“棋串”，棋串的最小单位是1个棋子，只含有单个棋子的棋串我们也用棋子来称呼它。整本书里对棋盘上所有棋子的思考方式都以棋串为基础。棋串能够存在于棋盘上，是依赖于“气”。所谓气，就是紧邻棋串周围的空点集合。气的个数就是这个集合元素的个数。如果棋串周围紧邻5个空点，我们就称这串棋有5口气。没有气的串棋不能存在于棋盘上。图1-4中用数字标识的4个点便是这颗黑色棋串的气。由于黑子周围没有被白字占领，所以这颗黑子一共有四口气。如果气的空子位被对方的子占领，则己方就减少一口气。如果图1-4中的空子位1被白子占领，黑子就只剩下了三口气。当执白方通过在棋盘上落子使得空子位1、2、3和4都被白子占领时，这颗黑子的气变为零，称为无气或者气绝，黑子成为一颗死子。死子不能在棋盘上存在，需要从棋盘上被挪走，这种将对方的棋串移出棋盘的行为我们称为“提子”。只要棋串没有了气，就必须清理出棋盘。

相同颜色的棋子通过棋盘上纵横交错的线进行连接组成棋串，这样相邻的棋子便可以共享各自的气。图1-5中，虽然左边的黑子上方被白棋占去了一口气，但是由于它右边紧邻着一颗黑子，所以它实际上有五口气。单颗棋子最多可以有四口气，而相邻的两颗子却只能有六口气。虽然多个棋子通过串接组成棋串可以增加了各自的存活率，但是从气的数量上来考虑，总的效益是下降的。在围棋行棋的初始阶段，双方往往都避免将自己的棋子连在一起，这其中将行棋的效益最大化便是需要考量的因素之一。

图1-6中， $$\times$$标记的白子和$$\Box$$标记的黑子共享A点这口气。如果此时由执黑方落子，黑子下到A点，虽然此时黑白双方都是无气状态，但是黑棋下完后应该立即提走$$\times$$标记的所有白子，这样 $$\Box$$ 标记的黑子便有了气，成为活子。

现代围棋规定，不允许将己方串棋的气变为0，即不允许自杀。这个可以导致自杀的落子点称作“禁着点”。图1-7中，如果此时执白方落子下到A点空位，由于周围的黑子都有气，白子不能提走黑子，而$$△$$标记的白子自己却没有了气，需要被从棋盘上提走，这种行为称为自杀。如果规则上不允许自杀，则执白方不允许在A点位上落子。

虽然大部分情况下自杀是没有意义的，但是有时候兵行险招未尝不是一种方案。图1-8虽然不具有实战意义，但是作为例子，它展现了自杀也是可以成为争取效益的一种手段。如果不允许自杀，通常会判定图中白子全部为死棋，执黑方胜。原因是若黑棋落在A位落子后就可以提走所有白子。但是如果允许自杀（[应氏规则](https://baike.baidu.com/item/%E5%BA%94%E6%B0%8F%E8%A7%84%E5%88%99/1680973?fr=aladdin)），执白方就可以落在A位，虽然也会被提走全部白子，但是由于空出的领域较大，白棋未必不能在其中争夺到一片领地。我想到金庸先生在小说《[天龙八部](http://www.jinyongwang.com/tian/)》中描写的珍珑棋局大概就属于这种情况。

虽然围棋的棋形千变万化，但这是站在$$19×19$$这样一个大棋盘上来说的。由于围棋规则简单，在行棋的进程中很容易在局部陷入简单变化，从而使得棋局陷入死循环。人们经提到的术语“打劫”就是一个常见的例子。“劫”是指围棋棋盘上一方落子提掉对方的棋串后，自己的这个落子也只剩下了一口气。这里专门提到劫是因为它是“禁止全局同形”规则的最典型样例。所谓禁止全局同形，就是指一方着子后不得使对方重复面临该局中曾出现过的局面。虽然打劫后己方只剩下了一口气，但是由于禁止全局同形的规则存在，对方不能立刻回提这个子，需要另外再下一着改变棋局后才可以在下一回合中再提走这个子。图1-9中的A点和B点都是典型的劫。

图1-10\(A\)和图1-10\(B\)就是典型的打劫案例。在图1-10\(A\)的局势下，当执白方下到A点空位，$$▲$$黑子被提走，局势变到图1-10\(B\)。此时若执黑方下到A点空位，执黑方提掉$$△$$白子，局势又回到了图1-10\(A\)的情况。若双方都不愿意改变策略，此局将进入死循环，无法结束。针对这种情况，围棋中规定，行棋的过程中，任何一方都不可以下出同之前自己下过的相同的围棋局面，围棋术语中称为禁止全局同型再现，即围棋中相同的局面不可以在一局中出现两次。在图1-10\(A\)的这个例子中，白棋下完$$A$$位后，黑棋便不可以再下图1-10\(B\)中的$$A$$位，因为这将会使得局面变回图1-10\(A\)，而图1-10\(A\)这局面是黑棋曾经下到过的，黑棋必须在其它位置上落子后，才可以继续在$$A$$位下棋。这种在其它位置落子的行为，专业术语就叫做“找劫材”。

围棋游戏的对抗目的就是要占据棋盘上尽量多的落子点。围棋的规则是双方轮流落子，且每次最多只能落一子，想要增加己方在棋盘上的点位，一种方法就是尽量多地提掉对方的子。为了提子，就必须减少对方棋串的气。把己方的棋子落在对方棋串的气上从而减少对方棋串的气的行为称作“紧气”。与紧气相对的围棋术语叫做“长气”，即通过落子增加己方棋串的气。紧气与长气是围棋中最基本的进攻与防守策略。连续的对某一棋串进行不停地“紧气”与“长气”的操作叫做“征”。征是一个非常特殊的落子过程，在这个过程中，一方不断地通过紧气来打吃对手，另一方则不断地通过长气来避免自己的棋串被对方提走。

做为围棋最基础的概念之一，“眼”是棋盘上被同种颜色的棋子所包围的一个空点。眼是棋串存活的基础，只要棋串的气大于眼的个数，那么己方的眼就是对方的禁着点。如果棋串有两个以上的眼，那么这串棋就不会被提走。围棋的眼又分真眼和假眼，图1-12中$$A$$和$$B$$是真眼，它们保证了黑方的棋串不会被白方提走，但是$$C$$点则是假眼，白方只要再下在$$D$$位，再下一步就可以破掉 $$C$$ 这个眼。关于真眼和假眼更详细的说明可以参考专业的围棋书籍。

## 1.3 胜负的判定

在下棋的过程中，任何一方都可以选择投子，即把两颗棋子放在棋盘的右下角表示认输，此时棋局终了。双方还可以连续依次地选择虚着，这样棋局也进入终了。如果双方以虚着终局便进入胜负判定环节。围棋流传世界各地，不同地方的文化不尽相同，围棋也相应地演变出了许多不同的规则，胜负判定也是一样。目前世界上使用较多的有[中国规则](https://baike.baidu.com/item/%E4%B8%AD%E5%9B%BD%E5%9B%B4%E6%A3%8B%E8%A7%84%E5%88%99/5425065?fr=aladdin)、[日韩规则](https://baike.baidu.com/item/%E6%97%A5%E6%9C%AC%E5%9B%B4%E6%A3%8B%E8%A7%84%E5%88%99%EF%BC%881989%E7%89%88%EF%BC%89/15175571)和应氏规则。在终局清算棋盘时，中国大陆采用数子规则，台湾采用应氏计点规则，日韩采用数目规则。数子法计算围取的地域，即双方占领的交叉点的数目。数目法计算双方围取的目数， 包括被提走的死子。围棋的本质是以占地圈地为目的游戏， 三种规则都考虑到执黑方先行棋存在一定优势，所有规则都采用了贴目制度。除去技术上采用的计算方式不同之外，三种规则在实践中的差异很小，胜负的结果基本一致。

日韩规则中，棋子所围成的空白交叉点叫做目，最终以目多的一方为胜方，所以日本的围棋规则称为比目法。这种方法要求对局时双方需要保留被提走的死子，终局后双方再将盘上的死子以及行棋过程中提掉的死子填入对方的实空中，然后再计算双方各自剩下的实空。最终结算时，黑棋贴给白棋6目半。如果白棋的实空加上贴目后的目数多于黑方则白胜，否则黑胜。

计算胜负时，中国规则与日韩规则有所不同。按照中国规则（数子法），一盘棋结束后，棋盘上的死子被拿掉，如果双方对是否死子产生争议，则通过实战解决。之后，如果黑棋活的棋子加上实空（目）达到185（黑棋由于先行优势须贴给白棋7目半）则黑胜，少于此数目则白胜。

而应氏规则是数各方占据的交叉点的数目，称作“计点”。其中黑棋贴7目半，占点多的一方胜，如果是和棋，则也是黑胜。除去比赛组织和棋手组织的一些规定外，就规则的核心部分而言，应氏规则与中国规则并无明显区别。

终局胜负计算时，日韩通常使用数目法，数目法需要黑棋贴目6又1/2。中国常用数子法，贴子3又3/4。中国规则在计算机实现上要比日韩规则方便许多，本书采用的就是中国规则。

在第二章中我们会手工编写程序实现基于中国规则的胜负判断方法，因此这里详细地描述一下中国规则的数子法。数子法规定围棋终局后需要首先将双方的死子清理出棋盘，而后按照以下方法来计算双方的子数：

1. 棋盘上每有一个黑子，就为黑方记得一子，白方每有一子，便记白方得一子；
2. 棋盘上的空点如果完全被黑棋包围黑方记一子，反之白方记一子，其它情况各记二分之一子。

在设计计算机围棋程序时，棋局必须要下到最后无点位可以落子才能结束。这是因为我们暂时还做不到为围棋人工智能引入精确的主观判断能力。目前来说，计算机如果不下到最后一刻是无法知道准确胜负的。上述第二点中各占二分之一子的情况在计算机的数子时是不应该出现的。如果一定要在中盘结束对弈，那就是默认后续无论如何着子都不会影响棋局的胜负结果，我们就可以轮流随机在棋盘上落子，直到填满棋盘后再进行胜负判断。

19路棋盘上一共有361个点可以落子，棋盘总数的一半是180又1/2，这个数字称作“归本数”。正常情况下子数多于归本数的一方为胜，如果双方子数一样则判为平局。实战中发现，先落子的黑方会占有一定的优势，于是我们需要在最终计数时补贴白方3又3/4子，这个行为叫做贴子。也就是说黑棋必须要计到超过184又1/4子才能赢棋。比如黑棋最终有185子，则黑棋以多3/4子胜白棋，如果黑棋有180子，则黑棋负白棋4又1/4子。

了解了上述这些基础概念后，下一章将根据这些围棋规则制作一款围棋软件，给它起个名字叫MyGo，后续的章节中会以MyGo这个围棋软件为基础来教会它下棋，并使其达到甚至超过大师级的水平。

## 1.4 围棋棋手的棋力

围棋棋手的等级包括段位和级位，它们是表示围棋手水平高低的标志。通常棋力从低到高分别为：业余级位，业余段位，职业段位。根据《[中国围棋业余段位级位制](https://www.tianqiweiqi.com/cn-go-yeyu-d-2020.html)》规定，业余极位分为1级、2级一直到25级，其中1级最高，25级最低。一个按照围棋规则随机落子的计算机程序就相当于业余25级。20级到11级一般属于初级入门，10级到1级表示具有中级围棋水平。段位与级位相反，最低为1级。业余段位从1段到7段，日本棋院还有业余8段。1段到7段棋力逐级增强，业余7段表示已经具备了职业棋手的能力。职业段位与业余段位不同，它更像是一种荣誉头衔。职业段位的段数和选手在不同层次的国际比赛中获得的奖项荣誉挂钩，并且一旦获得了某一级别的职业段位，这一荣誉就是终身的。业余段位不能直接和职业段位相比较，不过基本上职业段位选手的棋力至少和业余7段一样强。

业余中一个级别或者一个段位的棋力差别主要体现在开局前高一级别的棋手需要让低一级别的棋手先行一子，以此达到双方在公平的基础上对弈的目的。对于围棋的刚入门选手，假设其当前处于业余23级，如果他和职业九段李世石进行对弈下棋，他至少需要在棋盘上先落下30个棋子后才有可能战胜李世石。这种让对方先在棋盘上摆子然后才开始下棋的行为称作“让子”。让子和在终局结算时的贴子行为很像，只是一个发生在棋局开始前，一个发生在行棋结束后。

## 1.5 计算机眼中的围棋

围棋是一种采用黑白两色棋子在方形棋盘上进行对弈的游戏。标准的围棋竞技采用19x19路棋盘。《[梦溪笔谈](https://www.gushiwen.org/guwen/mengxi.aspx)》中探讨了围棋的变化数目，沈括认为“大约连书万字四十三个，即是局之大数”。但是实际数字甚至远远超过可观测宇宙的原子总数$$10^{75}$$，约为 $$3^{19×19}=3^{361}≈1.74×10^{172}$$。根据围棋规则，没有气的子不能存活，扣除这些状态（占1.196%）后的合法状态约有 $$2.08×10^{170}$$ 种。而计算机想要确保必胜，需要的计算量在 $$10^{600}$$ 以上。正是因为这个原因，在AlphaGo出现之前，围棋的智能程序一直无法达到像深蓝电脑这样可以战胜世界级象棋大师的棋力水平。1997年IBM的计算机“深蓝”击败俄籍世界国际象棋冠军加里·卡斯帕罗夫，之后经过18年的发展，棋力最高的围棋人工智能程序才勉强能达到业余5段围棋棋手的水准。在不让子的情况下，计算机根本无法击败职业棋手。2012年，在4台PC上运行的围棋程序Zen在让5子和让4子的情况下两次击败日籍九段棋手武宫正树。2013年，围棋程序Crazy Stone在让4子的情况下击败日籍九段棋手石田芳夫。

围棋的棋盘和棋子在计算机里以数组的形式保存。在计算机看来，一盘围棋长得就像图1-13中的样子。这是一个19×19的数组，计算机用它来表示围棋的棋盘，其中数字1表示黑棋，-1表示白棋，0表示可以落子的空位。

和音乐的传承方式一样，围棋也有自己的乐谱，称作“棋谱”。棋谱是一盘棋局对弈发展的过程纪录。在南北朝时期，就已经有了围棋棋谱的记载， 《[南史·柳恽传](http://wyw.5156edu.com/html/z7088m5646j4779.html)》载：“梁武帝好弈，使恽品定棋谱，登格者二百七十八人”。在还没有计算机之前，人们在纸上印刷棋盘，并在棋盘上绘上黑、白棋子，然后在黑、白棋双方落子的位置上注明该手的手数（见图1-14）。

### 1.5.1 SGF文件

计算机上也可以保存棋谱，目前电子版本的围棋棋谱格式已经有了标准化，公认的标准是[Smart Game Format](https://www.red-bean.com/sgf/)（SGF），暂时还没有中文名称，我们简称之为SGF文件。在后面章节讲述如何训练计算机AI学习下围棋时，棋谱就是最重要的学习资料。图1-15就是一局围棋对弈的行棋记录。其中（FF\[4\]）表示SGF文件的格式版本，目前最新版本是第四版，版本向下兼容。（SZ\[19\]）表示棋盘的大小。现今常见的棋盘除了19×19的规格还有13×13和9×9两种，这两种规格的棋盘一般只用于下快棋，也有15×15或者17×17的棋盘规格，但是比较罕见。（PB\[masato3012\]）和（PW\[petgo3\]）分别用于记录下棋者执黑方和执白方的名字。（RE\[W+Resign\]）记录这一局的棋局最终是哪方获胜，以何种方式获胜。这里的例子中，Resign表示是对方主动投降认输。也有（RE\[W+14.50\]）这种计法，表示执白方胜利，并且以多14.5子胜出。（RU\[Chinese\]）表示游戏采取的规则，Chinese表示采用中国规则。（HA\[2\]）表示有让子，并且此局让出了两子。（AB）表示由于让子，黑棋先行在棋盘上摆子的位置。如果是白棋先放子，则用（AW）表示。图中剩下的部分就是整个行棋过程的纪录。（W\[dc\]）表示白棋下到棋盘上d线和c线的交叉点上。（B\[pp\]）同理，表示黑棋下到棋盘上p线和p线的交叉点上。有时候在SGF文件的最后，还会有（TW）和（TB）标记，它用于记录白子和黑子在棋局结束后所围的方形领地。

棋盘的坐标系一般有四种，常见的有两种，分别是“横坐标为英文字母，纵坐标为阿拉伯数字的坐标系”和“横坐标和纵坐标都使用英文字母的坐标系”。SGF文件记录方法采用了后者。即棋盘的上方和下方用英文的前 19 个字母自左至右顺次标记它的 19 条纵线段，在棋盘的左边和右边用英文的前 19 个字母自下至上顺次标记它的 19 条横线段。不用特别记住这种记法，在后续章节中，我们会使用[sgfmill](https://mjw.woodcraft.me.uk/sgfmill/)这个python3的库（python2的用户可以使用[gomill](https://mjw.woodcraft.me.uk/gomill/)）来专门处理SGF格式文件。需要记住的是，SGF文件使用节点（node）的概念来组织文件，节点之间使用分号（;）隔开。从图1-15中可以看出，在行棋记录前，基础的元数据都被封装在第一个节点里，之后每一步落子都会产生一个新的独立节点。

### 1.5.2 GTP协议

要使我们在计算机上制作的围棋智能体具有实用性，与他人进行对弈是比不可少的。对弈可以和人进行，也可以让它和其它的计算机AI软件进行。为了方便人们通过计算机互联网相互交流围棋，[GTP](http://www.lysator.liu.se/~gunnar/gtp/)协议便应运而生。GTP的全称是Smart Game Format，它是一个文本传输协议，目前有GTP 1和GTP 2两个版本。GTP 2从2002年就开始了制定计划，但是似乎GTP 1运作的相当好，所以到目前为止GTP 2还一直停留在拟稿阶段。本书中使用GTP 1作为标准的围棋通信协议，但是也尽可能多地支持GTP 2，很多网络围棋软件会使用GTP 2中的命令。Bill Shubert曾草拟了一个GTP 4协议，但是还没有被广泛地接受。

